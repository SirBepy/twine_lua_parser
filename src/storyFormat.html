<html>

<head>
  <title>{{STORY_NAME}}</title>
  <script type="text/javascript">
    { { SCRIPT } }
  </script>
  <style>
    body,
    html {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      background-color: #365486;
      color: #7FC7D9;
    }

    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
    }

    #storyData {
      display: none;
    }

    #output {
      width: 500px;
      height: 500px;
      max-width: 80vw;
      max-height: 80vh;
      overflow-y: auto;
      text-wrap: wrap;
      opacity: 0.5;
      padding: 1em;
      border: #0F1035 4px solid;
      border-radius: 10px;
    }

    #unrecognizedNames {
      margin-top: 1em;
      width: 500px;
      max-width: 80vw;
      padding: 1em;
      border: #0F1035 4px solid;
      border-radius: 10px;
      background-color: #7FC7D9;
      color: white;
    }

    #unrecognizedNames button {
      margin-top: 0.5em;
    }

    button {
      width: 180px;
      height: 40px;
      border-radius: 10px;
      font-size: 1.2em;
      background-color: #7FC7D9;
      color: white;
      border: #DCF2F1 1px solid;
      transition: 0.2s;
      cursor: pointer;
    }

    button:hover {
      opacity: 0.5;
    }

    button:active {
      opacity: 0.2;
    }

    button:disabled {
      opacity: 1;
    }
  </style>
</head>

<body>
  <button onclick="copyText()">Copy output</button>
  <pre id="output"></pre>
  <div id="unrecognizedNames"></div>
  <div id="storyData">
    {{STORY_DATA}}
  </div>
  <script>
    const recognizedNames = JSON.parse(localStorage.getItem("recognizedNames") || "[]");

    function displayUnrecognizedNames(names) {
      const unrecognizedDiv = document.getElementById("unrecognizedNames");
      unrecognizedDiv.innerHTML = "<h3>Unrecognized Names:</h3>";

      names.forEach(name => {
        const nameDiv = document.createElement("div");
        nameDiv.textContent = name;

        const addButton = document.createElement("button");
        addButton.textContent = "Add to Names";
        addButton.onclick = () => addToRecognizedNames(name);

        const correctButton = document.createElement("button");
        correctButton.textContent = "Flag as Error";
        correctButton.onclick = () => alert(`Correct or verify the spelling of: ${name}`);

        nameDiv.appendChild(addButton);
        nameDiv.appendChild(correctButton);
        unrecognizedDiv.appendChild(nameDiv);
      });
    }

    function addToRecognizedNames(name) {
      recognizedNames.push(name);
      localStorage.setItem("recognizedNames", JSON.stringify(recognizedNames));
      alert(`${name} added to recognized names.`);
      parseTwineToLua(); // Re-run to remove recognized names from the list
    }

    function findUnrecognizedNames(text) {
      const nameRegex = /@(\w+)/g;
      const matches = [...text.matchAll(nameRegex)].map(match => match[1]);
      const unrecognized = matches.filter(name => !recognizedNames.includes(name));
      displayUnrecognizedNames(unrecognized);
    }

    function copyText() {
      const textToCopy = document.getElementById("output").innerText;
      const textarea = document.createElement("textarea");
      textarea.value = textToCopy;

      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);

      const button = document.querySelector('button');
      button.textContent = 'Copied to clipboard';
      button.disabled = true

      setTimeout(() => {
        button.textContent = 'Copy output';
        button.disabled = false
      }, 1500);
    }

    parseTwineToLua();
    findUnrecognizedNames(document.getElementById("output").innerText);
  </script>
</body>

</html>